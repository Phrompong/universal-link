<body>
  <h1>Redirect...</h1>
  <h2 id="status"></h2>

  <script>
    let storeTimeout;
    const iosStore = "https://apps.apple.com/app/id6742436661";
    const androidStore =
      "https://play.google.com/store/apps/details?id=com.surapich.medilance";
    const isAndroid = /android/i.test(userAgent);
    const isIOS = /iPhone|iPad|iPod/i.test(userAgent);

    function load() {
      try {
        const params = new URLSearchParams(window.location.search);

        const token = params.get("token");
        const again = params.get("isAgain");

        storeTimeout = setTimeout(() => {
          if (isIOS) {
            window.location = iosStore;
          } else if (isAndroid) {
            window.location = androidStore;
          } else {
            alert("Unsupported platform. Please use a mobile device.");
          }
        }, 1500);

        const isWebView =
          /wv/.test(navigator.userAgent) ||
          /WebView/.test(navigator.userAgent) ||
          /Safari/.test(navigator.userAgent);

        if (isWebView) {
          window.location =
            "com.surapich.medilance://change-password?token=" + token;
        }

        // ถ้าเว็บถูกซ่อน (เช่น แอปถูกเปิด) ให้ยกเลิก fallback
        document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "hidden") {
            clearTimeout(storeTimeout);
          }
        });
      } catch (e) {
        alert("Error: " + e);
        clearTimeout(storeTimeout);
      }
    }

    load();
  </script>
</body>
